<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>Math Logi Lab - Quiz Pro</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.js"></script>

    <style>
        :root { --primary: #0b3163; --accent: #00a774; --danger: #d00000; --white: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #0b3163; min-height: 100vh; color: #333; }

        /* ABERTURA */
        #login-screen {
            height: 100vh; width: 100%;
            background: url('https://raw.githubusercontent.com/mathlogi/quiz/main/PREPARA√á√ÉO EXAME 9¬∫ANO (15).png') no-repeat center center;
            background-size: cover; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 12vh;
        }
        .input-wrapper { background: white; border-radius: 50px; padding: 5px 15px; width: 85%; max-width: 450px; display: flex; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        #player-name-input { border: none; padding: 12px; width: 100%; font-size: 16px; text-align: center; outline: none; }
        #ok-btn { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        /* MENU */
        #quiz-selection { display: none; text-align: center; padding: 40px; background: #f0f2f5; min-height: 100vh; }
        #quiz-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1100px; margin: 0 auto; }
        @media (max-width: 768px) { #quiz-list { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { #quiz-list { grid-template-columns: 1fr; } }
        .quiz-card { background: white; padding: 25px; border-radius: 15px; border-top: 6px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* JOGO */
        .top-bar { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; }
        #timer-bar { height: 8px; background: var(--accent); width: 100%; transition: width 1s linear; }
        .box { background: white; padding: 30px; border-radius: 20px; margin: 20px auto; max-width: 750px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; }

        /* TECLADO MATEM√ÅTICO ESTILIZADO */
        #math-field { width: 90%; margin: 0 auto 15px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: #fafafa; min-height: 50px; font-size: 24px; display: inline-block; }
        #math-keyboard { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .kb-btn { 
            background: white; border: 2px solid var(--primary); color: var(--primary); 
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 16px; 
            min-width: 55px; height: 50px; font-weight: bold; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .kb-btn:hover { background: var(--primary); color: white; }

        /* BOT√ïES DE ESCOLHA M√öLTIPLA */
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 750px; margin: 0 auto; width: 90%; }
        .opt-btn { background: #0b3163; border: 2px solid #ffffff; color: white; padding: 20px; border-radius: 15px; font-size: 18px; cursor: pointer; transition: 0.2s; min-height: 80px; }
        .opt-btn:hover { background: #00a774; border-color: #00a774; }

        #feedback { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; color: white; font-size: 35px; font-weight: bold; z-index: 2000; text-align: center; background: rgba(0,0,0,0.85); }
        .hidden { display: none !important; }
        .submit-btn { background: var(--accent); padding: 15px 50px; border: none; color: white; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 18px; }
        
        #rank-screen { text-align: center; padding: 40px; background: #f0f2f5; min-height: 100vh; }
        table { width: 100%; max-width: 500px; margin: 20px auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: var(--primary); color: white; padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="input-wrapper">
            <input type="text" id="player-name-input" placeholder="O TEU NOME...">
            <button id="ok-btn" onclick="goToMenu()">OK</button>
        </div>
    </div>

    <div id="quiz-selection">
        <img src="https://raw.githubusercontent.com/mathlogi/quiz/main/PREPARA√á√ÉO EXAME 9¬∫ANO (15).png" style="max-width:180px; margin-bottom:20px;">
        <div id="quiz-list"></div>
    </div>

    <div id="game-ui" class="hidden">
        <div class="top-bar">
            <span id="q-info">Quest√£o</span>
            <span id="score-val">0 pts</span>
            <span id="t-txt">45s</span>
        </div>
        <div style="background:rgba(255,255,255,0.2)"><div id="timer-bar"></div></div>
        <div class="box">
            <div id="img-q"></div>
            <div id="txt-q" style="min-height: 60px;"></div>
            
            <div id="short-zone" class="hidden">
                <div id="math-field"></div>
                <div id="math-keyboard">
                    <button class="kb-btn" onclick="mqIn('x')">x</button>
                    <button class="kb-btn" onclick="mqIn('y')">y</button>
                    <button class="kb-btn" onclick="mqIn('+')">+</button>
                    <button class="kb-btn" onclick="mqIn('-')">-</button>
                    <button class="kb-btn" onclick="mqIn('\\cdot')">‚ãÖ</button>
                    <button class="kb-btn" onclick="mqIn('\\div')">√∑</button>
                    <button class="kb-btn" onclick="mqIn('(')">(</button>
                    <button class="kb-btn" onclick="mqIn(')')">)</button>
                    <button class="kb-btn" onclick="mqIn('\\frac{}{}')">a/b</button>
                    <button class="kb-btn" onclick="mqIn('^{}')">x‚Åø</button>
                    <button class="kb-btn" onclick="mqIn('\\sqrt{}')">‚àö</button>
                    <button class="kb-btn" onclick="mqIn('\\le')">‚â§</button>
                    <button class="kb-btn" onclick="mqIn('\\ge')">‚â•</button>
                </div>
                <button class="submit-btn" onclick="checkShort()">SUBMETER RESPOSTA</button>
            </div>
        </div>
        <div id="opt-grid" class="options"></div>
    </div>

    <div id="feedback"></div>

    <div id="rank-screen" class="hidden">
        <h2 style="color:var(--primary)">Quiz Conclu√≠do!</h2>
        <div id="res-grade" style="font-size: 60px; font-weight: bold; color: var(--accent); margin-bottom: 20px;"></div>
        <div id="congrats-area"></div>
        <div style="background: white; padding: 25px; border-radius: 15px; display: inline-block; width: 90%; max-width: 500px;">
            <h3>üèÜ TOP 5 GLOBAL</h3>
            <table id="table"></table>
        </div>
        <br><br><button onclick="location.reload()" class="submit-btn" style="background:var(--primary)">VOLTAR AO MENU</button>
    </div>

    <script src="perguntas.js"></script>
    <script>
        let cur = 0, pts = 0, time, tLeft, quiz, playerName, mathField;
        const MQ = MathQuill.getInterface(2);
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        const BIN_ID = '69a03d0843b1c97be9a0345b'; 
        const API_KEY = '$2a$10$uPoUexkH5KHeuMHnDPbc0O/tP1KH4rqeSLkGjLk8R6lsV4MXfeTEG';

        $(document).ready(function() {
            mathField = MQ.MathField(document.getElementById('math-field'), {
                handlers: { enter: function() { checkShort(); } }
            });
        });

        // FUN√á√ÉO DE RENDERIZA√á√ÉO MELHORADA
        function renderMath(element) {
            renderMathInElement(element, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false}
                ],
                throwOnError : false
            });
        }

        function mqIn(cmd) { mathField.write(cmd); mathField.focus(); }

        function play(f, d) {
            let o = audio.createOscillator(), g = audio.createGain();
            o.frequency.value = f; g.gain.value = 0.1;
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + d);
        }

        document.getElementById("player-name-input").addEventListener("keypress", (e) => { if (e.key === "Enter") goToMenu(); });

        function goToMenu() {
            const val = document.getElementById("player-name-input").value.trim();
            if(!val) return alert("Escreve o teu nome!");
            playerName = val;
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("quiz-selection").style.display = "block";
            renderQuizList();
        }

        function renderQuizList() {
            const listDiv = document.getElementById("quiz-list");
            listDiv.innerHTML = "";
            database.forEach(q => {
                const card = document.createElement("div");
                card.className = "quiz-card";
                card.innerHTML = `<div><strong>${q.title}</strong><br><small>${q.questions.length} quest√µes</small></div>
                <button onclick="startQuiz('${q.id}')" style="background:var(--accent); border:none; color:white; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:15px;">COME√áAR</button>`;
                listDiv.appendChild(card);
            });
        }

        function startQuiz(id) {
            quiz = database.find(x => x.id === id);
            cur = 0; pts = 0;
            document.getElementById("quiz-selection").style.display = "none";
            document.getElementById("game-ui").classList.remove("hidden");
            loadQuestion();
        }

        function loadQuestion() {
            clearInterval(time); tLeft = 45; 
            document.getElementById("score-val").innerText = pts + " pts";
            updateT();
            
            let q = quiz.questions[cur];
            const txtQ = document.getElementById("txt-q");
            txtQ.innerHTML = q.q;
            renderMath(txtQ); // Renderiza a pergunta

            document.getElementById("q-info").innerText = `Quest√£o ${cur+1}/${quiz.questions.length}`;
            document.getElementById("img-q").innerHTML = q.img ? `<img src="${q.img}" style="max-width:100%; max-height:250px; border-radius:10px; margin-bottom:15px;">` : "";
            
            const grid = document.getElementById("opt-grid"), sz = document.getElementById("short-zone");
            if(q.type === "multiple") {
                grid.classList.remove("hidden"); sz.classList.add("hidden");
                grid.innerHTML = "";
                q.opts.forEach((o, i) => {
                    let b = document.createElement("button"); 
                    b.className = "opt-btn"; 
                    b.innerHTML = o;
                    renderMath(b); // Renderiza as op√ß√µes
                    b.onclick = () => validate(i === q.ans, q.opts[q.ans]);
                    grid.appendChild(b);
                });
            } else {
                grid.classList.add("hidden"); sz.classList.remove("hidden");
                mathField.latex(""); setTimeout(() => mathField.focus(), 100);
            }
            time = setInterval(() => { tLeft--; updateT(); if(tLeft<=0) validate(false, q.type === "multiple" ? q.opts[q.ans] : q.ans); }, 1000);
        }

        function updateT() { document.getElementById("timer-bar").style.width = (tLeft/45*100)+"%"; document.getElementById("t-txt").innerText = tLeft+"s"; }

        function checkShort() { 
            const val = mathField.latex().replace(/\s/g, "");
            const correctAns = quiz.questions[cur].ans.replace(/\s/g, "");
            validate(val === correctAns, quiz.questions[cur].ans); 
        }

        function validate(isCorrect, rightAns) {
            clearInterval(time);
            const fb = document.getElementById("feedback");
            fb.style.display = "flex";
            if(isCorrect) { 
                pts += 10; 
                fb.innerHTML = "üéØ CORRETO!"; 
                fb.style.background = "rgba(0, 167, 116, 0.9)"; 
                play(600, 0.2); 
            } else { 
                fb.innerHTML = `‚ùå ERRADO!<br><br><span style="font-size:20px">Resposta:</span><br><div id='ans-corr'>${rightAns}</div>`; 
                renderMath(document.getElementById('feedback'));
                fb.style.background = "rgba(208, 0, 0, 0.9)"; 
                play(200, 0.3); 
            }
            setTimeout(() => { fb.style.display = "none"; cur++; if(cur < quiz.questions.length) loadQuestion(); else finish(); }, 3500);
        }

        async function finish() {
            document.getElementById("game-ui").classList.add("hidden");
            document.getElementById("rank-screen").classList.remove("hidden");
            let grade = Math.round((pts / (quiz.questions.length * 10)) * 100);
            document.getElementById("res-grade").innerText = grade + "%";
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                const data = await res.json();
                let ranks = data.record.record || [];
                ranks.push({ n: playerName, s: grade });
                ranks.sort((a, b) => b.s - a.s);
                const topRanks = ranks.slice(0, 10);
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ record: topRanks })
                });
                const myPos = topRanks.findIndex(r => r.n === playerName && r.s === grade) + 1;
                if(myPos > 0 && myPos <= 3) document.getElementById("congrats-area").innerHTML = `<div style="color:var(--accent); font-weight:bold; font-size:24px; margin-bottom:20px;">üèÜ BRILHANTE! Est√°s no Top 3 Global! üèÜ</div>`;
                document.getElementById("table").innerHTML = "<tr><th>Pos</th><th>Nome</th><th>Nota</th></tr>" + 
                    topRanks.slice(0, 5).map((x, i) => `<tr style="${i < 3 ? 'background:#e8f5e9; font-weight:bold;' : ''}"><td>${i+1}¬∫</td><td>${x.n}</td><td>${x.s}%</td></tr>`).join("");
            } catch (e) { document.getElementById("table").innerHTML = "<tr><td>Ranking em Manuten√ß√£o</td></tr>"; }
        }
    </script>
</body>
</html>
