<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>Quiz Educativo Pro</title>
    <style>
        :root { --primary: #0b3163; --accent: #00a774; --danger: #d00000; --white: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; min-height: 100vh; }
        #menu { padding: 50px; text-align: center; }
        .login-box { margin-bottom: 30px; }
        input#player-name-input { padding: 15px; width: 300px; border: 2px solid var(--primary); border-radius: 10px; font-size: 16px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 5px; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        .top-bar { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #timer-bar { height: 8px; background: var(--accent); width: 100%; transition: width 1s linear; }
        .box { background: white; padding: 30px; border-radius: 15px; margin: 20px auto; max-width: 600px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin: 0 auto; }
        #feedback { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; color: white; font-size: 30px; font-weight: bold; z-index: 100; text-align: center; }
        .hidden { display: none !important; }
        table { width: 100%; max-width: 400px; margin: 20px auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: var(--primary); color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; color: #333; text-align: center; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color: var(--primary)">üìö Plataforma de Quiz</h1>
        <div class="login-box">
            <p style="color: #666;">Introduz o teu nome para come√ßar:</p>
            <input type="text" id="player-name-input" placeholder="Teu nome...">
        </div>
        <div id="list"></div>
    </div>

    <div id="game" class="hidden">
        <div class="top-bar">
            <span id="q-info">Quest√£o</span>
            <span id="score">0 pts</span>
            <span id="t-txt">45s</span>
        </div>
        <div style="background:#ccc"><div id="timer-bar"></div></div>
        <div class="box">
            <div id="img-q"></div>
            <h2 id="txt-q">A carregar...</h2>
            <div id="short-zone" class="hidden">
                <input type="text" id="ans-in" placeholder="Escreve aqui..." style="width: 80%; margin-bottom: 15px; padding: 10px;">
                <br><button onclick="checkShort()">Responder</button>
            </div>
        </div>
        <div id="opt-grid" class="options"></div>
    </div>

    <div id="feedback"></div>

    <div id="rank" class="hidden" style="text-align:center; padding: 50px;">
        <h2 id="res-title">Fim do Quiz!</h2>
        <div id="res-grade" style="font-size: 60px; font-weight: bold; color: var(--accent); margin: 20px 0;"></div>
        <div style="background: white; padding: 20px; border-radius: 15px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h3 style="margin-top:0">üèÜ Ranking Global</h3>
            <div id="loading-rank">A carregar ranking...</div>
            <table id="table"></table>
        </div>
        <br><br><button onclick="location.reload()">Sair / Novo Jogo</button>
    </div>

    <script src="perguntas.js"></script>
    <script>
        let cur = 0, pts = 0, time, tLeft, quiz, playerName;
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- CONFIGURA√á√ÉO JSONBIN ---
        const BIN_ID = '69a03d0843b1c97be9a0345b'; 
        const API_KEY = '$2a$10$uPoUexkH5KHeuMHnDPbc0O/tP1KH4rqeSLkGjLk8R6lsV4MXfeTEG';

        function play(f, d) {
            let o = audio.createOscillator(), g = audio.createGain();
            o.frequency.value = f; g.gain.value = 0.1;
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + d);
        }

        window.onload = () => {
            const listDiv = document.getElementById("list");
            listDiv.innerHTML = ""; // Limpa para evitar duplicados
            database.forEach(q => {
                let btn = document.createElement("button");
                btn.innerText = "Jogar: " + q.title;
                btn.onclick = () => {
                    const nameVal = document.getElementById("player-name-input").value.trim();
                    if(!nameVal) { alert("Por favor, introduz o teu nome!"); return; }
                    playerName = nameVal; quiz = q;
                    document.getElementById("menu").classList.add("hidden");
                    document.getElementById("game").classList.remove("hidden");
                    load();
                };
                listDiv.appendChild(btn);
            });
        };

        function load() {
            clearInterval(time); tLeft = 45; updateT();
            let q = quiz.questions[cur];
            document.getElementById("txt-q").innerText = q.q;
            document.getElementById("q-info").innerText = `Quest√£o ${cur+1}/${quiz.questions.length}`;
            document.getElementById("img-q").innerHTML = q.img ? `<img src="${q.img}" style="max-height:200px; border-radius:10px; margin-bottom:15px;">` : "";
            const grid = document.getElementById("opt-grid"), sz = document.getElementById("short-zone");
            if(q.type === "multiple") {
                grid.classList.remove("hidden"); sz.classList.add("hidden");
                grid.innerHTML = "";
                q.opts.forEach((o, i) => {
                    let b = document.createElement("button"); b.innerText = o;
                    b.onclick = () => validate(i === q.ans, q.opts[q.ans]);
                    grid.appendChild(b);
                });
            } else {
                grid.classList.add("hidden"); sz.classList.remove("hidden");
                document.getElementById("ans-in").value = ""; document.getElementById("ans-in").focus();
            }
            time = setInterval(() => { tLeft--; updateT(); if(tLeft<=0) validate(false, q.type === "multiple" ? q.opts[q.ans] : q.ans); }, 1000);
        }

        function updateT() {
            document.getElementById("t-txt").innerText = tLeft+"s";
            document.getElementById("timer-bar").style.width = (tLeft/45*100)+"%";
            document.getElementById("timer-bar").style.background = tLeft < 10 ? "var(--danger)" : "var(--accent)";
        }

        function checkShort() { 
            const userAns = document.getElementById("ans-in").value.trim().toLowerCase();
            validate(userAns === quiz.questions[cur].ans.toLowerCase(), quiz.questions[cur].ans); 
        }

        function validate(isCorrect, rightAns) {
            clearInterval(time);
            const fb = document.getElementById("feedback");
            fb.style.display = "flex";
            if(isCorrect) { pts += 10; fb.innerText = "CORRETO! üéØ"; fb.style.background = "var(--accent)"; play(600, 0.2); }
            else { fb.innerText = "ERRADO! ‚ùå\nResposta: " + rightAns; fb.style.background = "var(--danger)"; play(200, 0.3); }
            setTimeout(() => { fb.style.display = "none"; cur++; if(cur < quiz.questions.length) load(); else finish(); }, 2500);
        }

        async function finish() {
            document.getElementById("game").classList.add("hidden");
            document.getElementById("rank").classList.remove("hidden");
            let grade = Math.round((pts / (quiz.questions.length * 10)) * 100);
            document.getElementById("res-grade").innerText = grade + "/100";

            try {
                // 1. Obter Ranking da Nuvem
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const data = await res.json();
                let ranks = data.record.record || []; // Acede √† estrutura que cri√°mos

                // 2. Adicionar nova nota
                ranks.push({ n: playerName, s: grade });
                ranks.sort((a, b) => b.s - a.s);
                const topRanks = ranks.slice(0, 10);

                // 3. Atualizar Nuvem
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ record: topRanks })
                });

                // 4. Mostrar Tabela
                document.getElementById("loading-rank").classList.add("hidden");
                document.getElementById("table").innerHTML = "<tr><th>Pos</th><th>Nome</th><th>Nota</th></tr>" + 
                    topRanks.slice(0, 5).map((x, i) => `<tr><td>${i+1}¬∫</td><td>${x.n}</td><td>${x.s}</td></tr>`).join("");
            } catch (e) {
                document.getElementById("loading-rank").innerText = "Erro ao sincronizar ranking global.";
            }
        }
    </script>
</body>
</html>
