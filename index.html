<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathLogi Lab</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer></script>

  <!-- MathQuill -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.js" defer></script>

  <style>
    :root { --primary:#0b3163; --accent:#00a774; --danger:#d00000; --gold:#ffd700; --muted:#e7ecf3; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:var(--primary); color:#333; overflow-x:hidden; }

    /* Login */
    #login-screen { height:100vh;
      background:url('https://raw.githubusercontent.com/mathlogi/quiz/main/PREPARA√á√ÉO EXAME 9¬∫ANO (10).svg') no-repeat center center/cover;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end; padding-bottom:12vh; }
    .input-wrapper { background:#fff; border-radius:50px; padding:5px 15px; width:85%; max-width:450px; display:flex; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
    #player-name-input { border:none; padding:12px; width:100%; outline:none; text-align:center; font-size:16px; }
    #ok-btn { background:var(--accent); color:#fff; border:none; padding:10px 25px; border-radius:50px; cursor:pointer; font-weight:bold; }

    /* Menu */
    #quiz-selection { display:none; text-align:center; padding:40px; background:#f0f2f5; min-height:100vh; }
    #quiz-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; max-width:1100px; margin:0 auto; }
    .quiz-card { background:#fff; padding:25px; border-radius:15px; border-top:6px solid var(--primary); box-shadow:0 4px 10px rgba(0,0,0,0.1); }

    /* Game */
    .top-bar { background:var(--primary); color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center; font-weight:bold; gap:10px; }
    #timer-bar-container { height:8px; background:rgba(255,255,255,0.2); width:100%; }
    #timer-bar { height:100%; background:var(--accent); width:100%; transition:width 1s linear; }

    .powerups { display:flex; justify-content:center; gap:15px; margin:15px 0; flex-wrap:wrap; }
    .pwr-btn { background:#fff; border:2px solid var(--gold); padding:8px 15px; border-radius:10px; cursor:pointer; font-weight:bold; }
    .pwr-btn:disabled { opacity:0.3; filter:grayscale(1); cursor:not-allowed; }

    .box { background:#fff; padding:30px; border-radius:20px; margin:10px auto; max-width:900px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.2); width:95%; }
    #img-q img { max-width:100%; max-height:220px; border-radius:10px; }

    /* Math input */
    #math-field { width:100%; max-width:820px; margin:15px auto; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:24px; min-height:52px; }

    /* Keyboard tabs */
    .kb-tabs { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:10px auto 6px; }
    .kb-tab { background:#fff; color:var(--primary); border:1.5px solid var(--primary); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
    .kb-tab.active { background:var(--primary); color:#fff; }

    /* Keyboard groups */
    #math-keyboard { background:var(--muted); border:1px solid #d6dde8; border-radius:10px; padding:10px; max-width:900px; margin:0 auto; }
    .kb-group { display:none; gap:6px; flex-wrap:wrap; justify-content:center; }
    .kb-group.active { display:flex; }
    .kb-btn { background:#fff; border:1.5px solid var(--primary); color:var(--primary); padding:8px 10px; border-radius:8px; cursor:pointer; font-size:15px; min-width:44px; min-height:38px; }
    .kb-btn.wide { min-width:72px; }
    .kb-row { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; width:100%; margin:4px 0; }

    .options { display:grid; grid-template-columns:1fr 1fr; gap:15px; max-width:900px; margin:0 auto; width:95%; }
    .opt-btn { background:var(--primary); color:#fff; border:2px solid #fff; padding:18px; border-radius:15px; font-size:18px; cursor:pointer; min-height:80px; }
    .opt-btn.wrong-option { visibility:hidden; pointer-events:none; }

    /* Feedback */
    #feedback { position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; color:#fff; z-index:9999; text-align:center; background:rgba(0,0,0,0.95); padding:30px; }
    .fb-math-ans { font-size:38px; background:rgba(255,255,255,0.1); padding:25px 50px; border-radius:15px; border:2px solid var(--accent); margin-top:20px; min-width:200px; }

    /* Rank */
    #rank-screen { text-align:center; padding:40px; background:#f0f2f5; min-height:100vh; }
    table { width:100%; max-width:500px; margin:20px auto; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th { background:var(--primary); color:#fff; padding:15px; }
    td { padding:12px; border-bottom:1px solid #eee; text-align:center; }

    .hidden { display:none !important; }
    .submit-btn { background:var(--accent); padding:15px 50px; border:none; color:#fff; border-radius:50px; cursor:pointer; font-weight:bold; font-size:18px; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="input-wrapper">
      <input type="text" id="player-name-input" placeholder="INTRODUZ O TEU NOME..." />
      <button id="ok-btn" onclick="goToMenu()">OK</button>
    </div>
  </div>

  <!-- MENU QUIZ -->
  <div id="quiz-selection">
    <img src="https://raw.githubusercontent.com/mathlogi/quiz/main/PREPARA√á√ÉO EXAME 9¬∫ANO (11).svg" style="max-width:160px; margin-bottom:15px;" alt="Math Logi Lab">
    <div id="quiz-list"></div>
  </div>

  <!-- GAME UI -->
  <div id="game-ui" class="hidden">
    <div class="top-bar">
      <span id="q-info">Quest√£o</span>
      <span id="score-val">0 pts</span>
      <span id="t-txt">120s</span>
    </div>
    <div id="timer-bar-container"><div id="timer-bar"></div></div>

    <div class="powerups">
      <button id="pwr-50" class="pwr-btn" onclick="use5050()">üåì 50/50</button>
      <button id="pwr-x3" class="pwr-btn" onclick="useX3()">üöÄ PONTOS x3</button>
      <button id="pwr-stop" class="pwr-btn" onclick="useStop()">‚è≥ STOP TEMPO</button>
    </div>

    <div class="box">
      <div id="img-q"></div>
      <div id="txt-q" style="font-size:22px;"></div>

      <!-- Short answer zone + EXPANDED KEYBOARD -->
      <div id="short-zone" class="hidden">
        <div id="math-field"></div>

        <!-- Keyboard Tabs -->
        <div class="kb-tabs" id="kb-tabs">
          <button class="kb-tab active" data-tab="basic">B√°sico</button>
          <button class="kb-tab" data-tab="algebra">√Ålgebra</button>
          <button class="kb-tab" data-tab="triglog">Trig/Logs</button>
          <button class="kb-tab" data-tab="calc">C√°lculo</button>
          <button class="kb-tab" data-tab="sets">Conj./L√≥gica</button>
          <button class="kb-tab" data-tab="vectors">Vetores/Matrizes</button>
          <button class="kb-tab" data-tab="complex">Complexos/Misc</button>
          <button class="kb-tab" data-tab="edit">Edi√ß√£o</button>
        </div>

        <!-- Keyboard Groups -->
        <div id="math-keyboard">
          <!-- BASIC -->
          <div class="kb-group active" data-tab="basic">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('7')">7</button>
              <button class="kb-btn" onclick="mqWrite('8')">8</button>
              <button class="kb-btn" onclick="mqWrite('9')">9</button>
              <button class="kb-btn" onclick="mqWrite('+')">+</button>
              <button class="kb-btn" onclick="mqWrite('-')">‚àí</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('4')">4</button>
              <button class="kb-btn" onclick="mqWrite('5')">5</button>
              <button class="kb-btn" onclick="mqWrite('6')">6</button>
              <button class="kb-btn" onclick="mqWrite('\\cdot')">√ó</button>
              <button class="kb-btn" onclick="mqWrite('\\div')">√∑</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('1')">1</button>
              <button class="kb-btn" onclick="mqWrite('2')">2</button>
              <button class="kb-btn" onclick="mqWrite('3')">3</button>
              <button class="kb-btn" onclick="mqWrite('0')">0</button>
              <button class="kb-btn" onclick="mqWrite('.')">.</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn wide" onclick="mqWrite('\\frac{}{}')">a/b</button>
              <button class="kb-btn" onclick="mqWrite('^{}')">x‚Åø</button>
              <button class="kb-btn" onclick="mqWrite('_{}')">x‚Çô</button>
              <button class="kb-btn" onclick="mqWrite('\\sqrt{}')">‚àö</button>
              <button class="kb-btn" onclick="mqWrite('\\sqrt[]{}')">‚Åø‚àö</button>
              <button class="kb-btn" onclick="mqWrite('(')">(</button>
              <button class="kb-btn" onclick="mqWrite(')')">)</button>
              <button class="kb-btn" onclick="mqWrite('[')">[</button>
              <button class="kb-btn" onclick="mqWrite(']')">]</button>
              <button class="kb-btn" onclick="mqWrite('\\{')">{</button>
              <button class="kb-btn" onclick="mqWrite('\\}')">}</button>
              <button class="kb-btn" onclick="mqWrite('| |')">| |</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\pi')">œÄ</button>
              <button class="kb-btn" onclick="mqWrite('e')">e</button>
              <button class="kb-btn" onclick="mqWrite('x')">x</button>
              <button class="kb-btn" onclick="mqWrite('y')">y</button>
              <button class="kb-btn" onclick="mqWrite('z')">z</button>
              <button class="kb-btn" onclick="mqWrite('=')">=</button>
              <button class="kb-btn" onclick="mqWrite(',')">,</button>
            </div>
          </div>

          <!-- ALGEBRA -->
          <div class="kb-group" data-tab="algebra">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('a')">a</button>
              <button class="kb-btn" onclick="mqWrite('b')">b</button>
              <button class="kb-btn" onclick="mqWrite('c')">c</button>
              <button class="kb-btn" onclick="mqWrite('m')">m</button>
              <button class="kb-btn" onclick="mqWrite('n')">n</button>
              <button class="kb-btn" onclick="mqWrite('\\binom{}{}')">nCk</button>
              <button class="kb-btn" onclick="mqWrite('\\approx')">‚âà</button>
              <button class="kb-btn" onclick="mqWrite('\\propto')">‚àù</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('<')">&lt;</button>
              <button class="kb-btn" onclick="mqWrite('>')">&gt;</button>
              <button class="kb-btn" onclick="mqWrite('\\le')">‚â§</button>
              <button class="kb-btn" onclick="mqWrite('\\ge')">‚â•</button>
              <button class="kb-btn" onclick="mqWrite('\\neq')">‚â†</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn wide" onclick="mqWrite('\\begin{cases} \\\\ \\end{cases}')">Sistema {}</button>
              <button class="kb-btn" onclick="mqWrite('\\overline{}')">sobrelinha</button>
              <button class="kb-btn" onclick="mqWrite('\\lfloor\\rfloor')">‚åä ‚åã</button>
              <button class="kb-btn" onclick="mqWrite('\\lceil\\rceil')">‚åà ‚åâ</button>
            </div>
          </div>

          <!-- TRIG/LOG -->
          <div class="kb-group" data-tab="triglog">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\sin')">sin</button>
              <button class="kb-btn" onclick="mqWrite('\\cos')">cos</button>
              <button class="kb-btn" onclick="mqWrite('\\tan')">tan</button>
              <button class="kb-btn" onclick="mqWrite('\\arcsin')">arcsin</button>
              <button class="kb-btn" onclick="mqWrite('\\arccos')">arccos</button>
              <button class="kb-btn" onclick="mqWrite('\\arctan')">arctan</button>
              <button class="kb-btn" onclick="mqWrite('^{{-1}}')">x‚Åª¬π</button>
              <button class="kb-btn" onclick="mqWrite('^\\circ')">¬∞</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\ln')">ln</button>
              <button class="kb-btn" onclick="mqWrite('\\log')">log</button>
              <button class="kb-btn wide" onclick="mqWrite('\\log_{}()')">log‚Çç‚Çé base</button>
            </div>
          </div>

          <!-- C√ÅLCULO -->
          <div class="kb-group" data-tab="calc">
            <div class="kb-row">
              <button class="kb-btn wide" onclick="mqWrite('\\lim_{x\\to }')">lim x‚Üí</button>
              <button class="kb-btn" onclick="mqWrite('\\to')">‚Üí</button>
              <button class="kb-btn wide" onclick="mqWrite('\\frac{d}{dx}')">d/dx</button>
              <button class="kb-btn" onclick="mqWrite('\\int')">‚à´</button>
              <button class="kb-btn wide" onclick="mqWrite('\\int_{}^{}')">‚à´ a^b</button>
              <button class="kb-btn" onclick="mqWrite('\\sum_{}^{}')">‚àë</button>
              <button class="kb-btn" onclick="mqWrite('\\prod_{}^{}')">‚àè</button>
            </div>
          </div>

          <!-- CONJUNTOS/L√ìGICA -->
          <div class="kb-group" data-tab="sets">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\in')">‚àà</button>
              <button class="kb-btn" onclick="mqWrite('\\notin')">‚àâ</button>
              <button class="kb-btn" onclick="mqWrite('\\subset')">‚äÇ</button>
              <button class="kb-btn" onclick="mqWrite('\\subseteq')">‚äÜ</button>
              <button class="kb-btn" onclick="mqWrite('\\cup')">‚à™</button>
              <button class="kb-btn" onclick="mqWrite('\\cap')">‚à©</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\forall')">‚àÄ</button>
              <button class="kb-btn" onclick="mqWrite('\\exists')">‚àÉ</button>
              <button class="kb-btn" onclick="mqWrite('\\neg')">¬¨</button>
              <button class="kb-btn" onclick="mqWrite('\\land')">‚àß</button>
              <button class="kb-btn" onclick="mqWrite('\\lor')">‚à®</button>
              <button class="kb-btn" onclick="mqWrite('\\implies')">‚áí</button>
              <button class="kb-btn" onclick="mqWrite('\\iff')">‚áî</button>
            </div>
          </div>

          <!-- VETORES/MATRIZES -->
          <div class="kb-group" data-tab="vectors">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('\\vec{v}')">‚Üív</button>
              <button class="kb-btn" onclick="mqWrite('\\cdot')">¬∑</button>
              <button class="kb-btn" onclick="mqWrite('\\times')">√ó</button>
              <button class="kb-btn wide" onclick="mqWrite('\\|\\|\\,\\|\\|')">‚Äñ ‚Äñ</button>
              <button class="kb-btn" onclick="mqWrite('\\angle')">‚à†</button>
            </div>
            <div class="kb-row">
              <button class="kb-btn wide" onclick="mqWrite('\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}')">Matriz 2√ó2</button>
              <button class="kb-btn wide" onclick="mqWrite('\\begin{pmatrix}  \\end{pmatrix}')">( ) matriz</button>
            </div>
          </div>

          <!-- COMPLEXOS / MISC -->
          <div class="kb-group" data-tab="complex">
            <div class="kb-row">
              <button class="kb-btn" onclick="mqWrite('i')">i</button>
              <button class="kb-btn" onclick="mqWrite('\\overline{z}')">zÃÑ</button>
              <button class="kb-btn" onclick="mqWrite('\\Re')">Re</button>
              <button class="kb-btn" onclick="mqWrite('\\Im')">Im</button>
              <button class="kb-btn" onclick="mqWrite('\\infty')">‚àû</button>
              <button class="kb-btn" onclick="mqWrite('\\Gamma')">Œì</button>
              <button class="kb-btn" onclick="mqWrite('\\Delta')">Œî</button>
              <button class="kb-btn" onclick="mqWrite('\\Sigma')">Œ£</button>
              <button class="kb-btn" onclick="mqWrite('\\Omega')">Œ©</button>
              <button class="kb-btn" onclick="mqWrite('\\alpha')">Œ±</button>
              <button class="kb-btn" onclick="mqWrite('\\beta')">Œ≤</button>
              <button class="kb-btn" onclick="mqWrite('\\gamma')">Œ≥</button>
              <button class="kb-btn" onclick="mqWrite('\\theta')">Œ∏</button>
              <button class="kb-btn" onclick="mqWrite('\\lambda')">Œª</button>
              <button class="kb-btn" onclick="mqWrite('\\mu')">Œº</button>
              <button class="kb-btn" onclick="mqWrite('\\sigma')">œÉ</button>
              <button class="kb-btn" onclick="mqWrite('\\phi')">œÜ</button>
              <button class="kb-btn" onclick="mqWrite('\\omega')">œâ</button>
            </div>
          </div>

          <!-- EDI√á√ÉO -->
          <div class="kb-group" data-tab="edit">
            <div class="kb-row">
              <button class="kb-btn wide" onclick="mqKey('Backspace')">‚å´</button>
              <button class="kb-btn" onclick="mqKey('Left')">‚óÄ</button>
              <button class="kb-btn" onclick="mqKey('Right')">‚ñ∂</button>
              <button class="kb-btn wide" onclick="mqClear()">C</button>
              <button class="kb-btn wide" onclick="checkShort()">Enter</button>
            </div>
          </div>
        </div>

        <br />
        <button class="submit-btn" onclick="checkShort()">SUBMETER</button>
      </div>
    </div>

    <div id="opt-grid" class="options"></div>
  </div>

  <!-- FEEDBACK -->
  <div id="feedback" aria-live="polite">
    <div id="fb-icon" style="font-size:80px;"></div>
    <div id="fb-msg" style="font-size:30px; font-weight:bold; margin-top:10px;"></div>
    <div id="fb-correct-ans" class="fb-math-ans"></div>
  </div>

  <!-- RANK -->
  <div id="rank-screen" class="hidden">
    <h2 style="color:var(--primary)">Quiz Conclu√≠do!</h2>
    <div id="res-grade" style="font-size:60px; font-weight:bold; color:var(--accent); margin-bottom:20px;"></div>
    <div id="congrats-area"></div>
    <div style="background:#fff; padding:25px; border-radius:15px; display:inline-block; width:90%; max-width:500px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
      <h3 style="margin:0 0 15px 0">üèÜ TOP 5 GLOBAL</h3>
      <table id="table"></table>
    </div>
    <br /><br /><button onclick="location.reload()" class="submit-btn" style="background:var(--primary)">VOLTAR AO MENU</button>
  </div>

  <!-- Perguntas (tem de estar na MESMA pasta) -->
  <script src="perguntas.js"></script>

  <script>
    // =========================
    // Estado, Audio e Config
    // =========================
    let cur = 0, pts = 0, hits = 0, time, tLeft, quiz, playerName, mathField;
    let isX3 = false, timerPaused = false;
    let pwrUsed = { fifty: false, x3: false, stop: false };

    const MQ = MathQuill.getInterface(2);

    // Ranking (como no original)
    const BIN_ID  = '69a03d0843b1c97be9a0345b';
    const API_KEY = '$2a$10$uPoUexkH5KHeuMHnDPbc0O/tP1KH4rqeSLkGjLk8R6lsV4MXfeTEG';

    // √Åudio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function tryResumeAudio() { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }
    document.addEventListener('pointerdown', tryResumeAudio, { once: true });
    document.addEventListener('keydown', tryResumeAudio, { once: true });

    function playSound(freq, type) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type || 'sine';
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 1);
    }

    // =========================
    // Utilit√°rios
    // =========================
    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function safeRender(el, textWithDollar) {
      // N√£o usar innerHTML c/ conte√∫do arbitr√°rio ‚Üí define como texto e deixa o auto-render transformar
      el.textContent = textWithDollar || '';
      renderMathInElement(el, { delimiters: [{left:'$', right:'$', display:false}], throwOnError:false });
    }

    function normalizeLatex(l) {
      return String(l || '')
        .replace(/\\left|\\right/g, '')
        .replace(/\\cdot|\\times/g, '*')
        .replace(/\s+/g, '')
        .replace(/[{}]/g, '')
        .replace(/\\ /g, '');
    }
    function eqWithSwap(a,b) {
      if (a === b) return true;
      const [a1,a2] = a.split('='), [b1,b2] = b.split('=');
      if (a1 && a2 && b1 && b2) return (a1 === b2 && a2 === b1);
      return false;
    }

    // MathQuill helpers
    function mqWrite(latex) { mathField.write(latex); mathField.focus(); }
    function mqKey(key)     { mathField.keystroke(key); mathField.focus(); }
    function mqClear()      { mathField.latex(''); mathField.focus(); }

    // =========================
    // Arranque
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      const mf = document.getElementById('math-field');
      if (mf) {
        mathField = MQ.MathField(mf, { handlers: { enter: checkShort } });
      }

      // Tabs do teclado
      const tabs = document.querySelectorAll('.kb-tab');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.getAttribute('data-tab');
        document.querySelectorAll('.kb-group').forEach(g => {
          g.classList.toggle('active', g.getAttribute('data-tab') === tab);
        });
      }));
    });

    // =========================
    // Fluxo do Jogo
    // =========================
    function goToMenu() {
      playerName = document.getElementById("player-name-input").value.trim();
      if (!playerName) return alert("Nome sff!");
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("quiz-selection").style.display = "block";
      renderQuizList();
    }

    function renderQuizList() {
      const list = document.getElementById("quiz-list");
      if (!Array.isArray(window.database) || window.database.length === 0) {
        list.innerHTML = '<div class="quiz-card"><strong>Sem dados</strong><br><small>0 quest√µes</small><br><em>N√£o foi poss√≠vel carregar as perguntas. Verifica o ficheiro perguntas.js.</em></div>';
        return;
      }
      list.innerHTML = window.database.map(q => `
        <div class="quiz-card">
          <strong>${escapeHtml(q.title)}</strong><br><small>${q.questions.length} quest√µes</small><br>
          <button onclick="startQuiz('${escapeHtml(q.id)}')" style="background:var(--accent); color:#fff; border:none; padding:10px; border-radius:8px; cursor:pointer; margin-top:10px; width:100%;">JOGAR</button>
        </div>
      `).join("");
    }

    function startQuiz(id) {
      const base = window.database.find(x => x.id === id);
      if (!base) { alert("Quiz n√£o encontrado."); return; }
      quiz = JSON.parse(JSON.stringify(base));
      quiz.questions = shuffle(quiz.questions);
      cur = 0; pts = 0; hits = 0;
      pwrUsed = { fifty: false, x3: false, stop: false };
      updatePwrButtons();

      document.getElementById("quiz-selection").style.display = "none";
      document.getElementById("game-ui").classList.remove("hidden");

      // Preload imagens
      quiz.questions.filter(q => q.img).forEach(u => { const im = new Image(); im.src = u.img; });

      loadQuestion();
    }

    function loadQuestion() {
      clearInterval(time);
      tLeft = 120; timerPaused = false; isX3 = false;
      updateT();
      document.getElementById("score-val").innerText = pts + " pts";

      const q = quiz.questions[cur];
      // Texto e imagem
      safeRender(document.getElementById("txt-q"), q.q || "");
      document.getElementById("q-info").innerText = `Quest√£o ${cur + 1}/${quiz.questions.length}`;
      document.getElementById("img-q").innerHTML = q.img ? `<img src="${encodeURI(q.img)}" alt="Quest√£o">` : "";

      const grid = document.getElementById("opt-grid");
      const sz = document.getElementById("short-zone");

      if (q.type === "multiple") {
        grid.classList.remove("hidden");
        sz.classList.add("hidden");
        grid.innerHTML = "";
        q.opts.forEach((o, i) => {
          const btn = document.createElement('button');
          btn.className = 'opt-btn';
          // Render seguro: coloca texto e deixa KaTeX substituir
          btn.textContent = o;
          renderMathInElement(btn, { delimiters: [{left:'$', right:'$', display:false}], throwOnError:false });
          btn.addEventListener('click', () => {
            const isCorrect = (i === q.ans);
            const rightAns = q.opts[q.ans];
            validate(isCorrect, rightAns);
          });
          grid.appendChild(btn);
        });
        requestAnimationFrame(() => {
          const firstBtn = document.querySelector('.opt-btn:not(.wrong-option)');
          if (firstBtn) firstBtn.focus();
        });
      } else {
        grid.classList.add("hidden");
        sz.classList.remove("hidden");
        mathField.latex("");
        requestAnimationFrame(() => mathField.focus());
      }

      time = setInterval(() => {
        if (!timerPaused) {
          tLeft--; updateT();
          if (tLeft <= 0) {
            const rightAns = (q.type === "multiple") ? q.opts[q.ans] : q.ans;
            validate(false, rightAns);
          }
        }
      }, 1000);
    }

    function updateT() {
      document.getElementById("timer-bar").style.width = (tLeft/120*100) + "%";
      document.getElementById("t-txt").innerText = timerPaused ? "‚è∏ STOP" : (tLeft + "s");
    }

    function updatePwrButtons() {
      document.getElementById("pwr-50").disabled = pwrUsed.fifty;
      document.getElementById("pwr-x3").disabled = pwrUsed.x3;
      document.getElementById("pwr-stop").disabled = pwrUsed.stop;
    }

    function use5050() {
      const q = quiz.questions[cur];
      if (q.type !== 'multiple' || pwrUsed.fifty) return;
      pwrUsed.fifty = true; updatePwrButtons();
      const btns = Array.from(document.querySelectorAll('.opt-btn'));
      const total = q.opts.length;
      const idxs = [...Array(total).keys()];
      shuffle(idxs);
      let removed = 0;
      idxs.forEach(i => {
        if (i !== q.ans && removed < 2) {
          btns[i].classList.add('wrong-option');
          removed++;
        }
      });
      playSound(440, 'square');
    }

    function useX3() { if (pwrUsed.x3) return; pwrUsed.x3 = true; isX3 = true; updatePwrButtons(); playSound(880, 'sine'); }

    // STOP TEMPO: pausa at√© responder
    function useStop() {
      if (pwrUsed.stop) return;
      pwrUsed.stop = true; timerPaused = true; updatePwrButtons(); playSound(330, 'triangle');
      updateT();
    }

    function checkShort() {
      const q = quiz.questions[cur];
      const user = normalizeLatex(mathField.latex());
      const correct = normalizeLatex(q.ans);
      validate(user === correct || eqWithSwap(user, correct), q.ans);
    }

    function validate(isCorrect, rightAns) {
      clearInterval(time);
      const fb = document.getElementById("feedback");
      fb.style.display = "flex";

      if (isCorrect) {
        const gain = isX3 ? 30 : 10;
        pts += gain; hits += 1;
        document.getElementById("fb-icon").innerText = "üéØ";
        document.getElementById("fb-msg").innerText = isX3 ? "TRIUNFO X3! +" + gain : "CORRETO!";
        const ansBox = document.getElementById("fb-correct-ans");
        ansBox.style.display = "none";
        fb.style.background = "rgba(0, 167, 116, 0.98)";
        playSound(660, 'sine');
      } else {
        document.getElementById("fb-icon").innerText = "‚ùå";
        document.getElementById("fb-msg").innerText = "ESTUDAR MAIS!";
        const ansBox = document.getElementById("fb-correct-ans");
        ansBox.style.display = "block";
        ansBox.textContent = "$" + rightAns + "$";
        renderMathInElement(ansBox, { delimiters: [{left:'$', right:'$', display:false}], throwOnError:false });
        fb.style.background = "rgba(208, 0, 0, 0.98)";
        playSound(150, 'sawtooth');
      }

      setTimeout(() => {
        fb.style.display = "none";
        cur++;
        if (cur < quiz.questions.length) loadQuestion(); else finish();
      }, 3500);
    }

    // =========================
    // Ranking (JSONBin como no original)
    // =========================
    async function finish() {
      document.getElementById("game-ui").classList.add("hidden");
      document.getElementById("rank-screen").classList.remove("hidden");

      // Nota como no original: pts em base 10 por pergunta
      let grade = Math.round((pts / (quiz.questions.length * 10)) * 100);
      document.getElementById("res-grade").innerText = grade + "%";

      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
        const data = await res.json();
        let ranks = data.record?.record || data.record || [];
        if (!Array.isArray(ranks)) ranks = [];
        ranks.push({ n: playerName, s: grade });
        ranks.sort((a, b) => b.s - a.s);
        const topRanks = ranks.slice(0, 10);
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
          body: JSON.stringify({ record: topRanks })
        });
        document.getElementById("table").innerHTML =
          "<tr><th>Pos</th><th>Nome</th><th>Nota</th></tr>" +
          topRanks.slice(0, 5).map((x, i) =>
            `<tr><td>${i+1}¬∫</td><td>${escapeHtml(x.n || '')}</td><td>${x.s}%</td></tr>`
          ).join("");
      } catch (e) {
        document.getElementById("table").innerHTML = "<tr><td>Ranking Offline</td></tr>";
      }
    }
  </script>
</body>
</html>
